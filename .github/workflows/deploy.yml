name: Deploy to EC2 with CodeDeploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Zip application
      run: |
        zip -r deploy.zip app.py appspec.yml scripts/

    - name: Upload to S3
      uses: aws-actions/aws-s3@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
        region: ap-northeast-2
        bucket: ttasup-dev-bucket
        source: deploy.zip
        destination: deploy/deploy.zip

    - name: Deploy with CodeDeploy
      uses: aws-actions/aws-codedeploy@v0.3.1
      with:
        application-name: test_cicd
        deployment-group: test-cicd-deploygroup
        deployment-bucket: ttasup-dev-bucket
        deployment-key: deploy/deploy.zip
        region: ap-northeast-2
